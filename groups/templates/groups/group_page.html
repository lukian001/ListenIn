{% extends 'base_layout.html' %}
{% load tz %}

{% block title %}
    <title> Group: {{ group.name }}</title>
{% endblock %}

{% block content %}
    <div class="jumbotron">
        <div class="container text-center">
            <h3>{{ group.name }}</h3>
            <p>{{ group.groupprofile.description }}</p>
        </div>
    </div>

    {% if is_admin %}
        <form class = "d-flex">
            <button type = "button" style="margin-bottom: 10px" class="btn btn-lg btn-primary"  data-bs-toggle="modal" data-bs-target="#changeGroupModal">Change</button>
        </form>

        <div class="modal fade" id="changeGroupModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Change group info</h5>
                    </div>
                    <div class="modal-body">
                        <form class="site-form" action="{% url 'groups:change_group' group_name=group.name %}" method="post" id="create-group-form">
                            {% csrf_token %}
                            {{ change_form }}
                        </form>
                        <form class="site-form" action="{% url 'groups:delete_group' group_name=group.name %}" method="post" id="delete-group-form">
                            {% csrf_token %}
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" form="create-group-form">Change group</button>
                        <button type="submit" class="btn btn-primary" form="delete-group-form">Delete group</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <form class = "site-form d-flex" method = "post" action = "{% url 'groups:enter_group' group_name=group.name %}" id = "enter-group">
        {% csrf_token %}
        {% if is_member %}
            <button type = "submit" class = "btn btn-lg btn-primary" form = "leave-group">Leave group</button>
        {% else %}
            <button type = "submit" class = "btn btn-lg btn-primary" form = "enter-group">Enter group</button>
        {% endif %}
    </form>

    <form class = "site-form d-flex" method = "post" action = "{% url 'groups:leave_group' group_name=group.name %}" id = "leave-group">
        {% csrf_token %}
    </form>

    <div style="overflow-y: auto; border-radius: 4px; height: 100%; word-break: normal; margin-top: 10px" class="col-sm-10 bg-light border">
        <h2 style = "text-align: center">Feed</h2>
        <div class="vstack gap-3" style="margin-top: 20px;">
            {% for post in posts %}
                <div class="card mb-3" style="width: 100%">
                    <div class="row no-gutters">
                        {% if post.media %}
                            {% if post.type == 1 %}
                                <div class="card-body">
                                    <h5 class="card-title"><a href="{% url 'accounts:user_account' username=post.owner.username %}">{{ post.owner.get_full_name }}</a>
                                    posted:</h5>
                                    <p class="card-text">{{ post.text }}</p>
                                        <div class="col">
                                            <audio controls style="width: 100%">
                                            <source src="{{ post.media.url }}">
                                            </audio>
                                        </div>
                                    <p class="card-text"><small class="text-muted">{{ post.date|timezone:"Europe/Bucharest" }}</small></p>
                                </div>
                            {% endif %}
                            {% if post.type == 2 %}
                                <div class="col">
                                    <video controls="controls" preload="preload" style="height: auto; width: 240px">
                                        <source src="{{ post.media.url }}" type="video/mp4">
                                    </video>
                                </div>
                                <div class="col-10">
                                <div class="card-body">
                                    <h5 class="card-title"><a href="{% url 'accounts:user_account' username=post.owner.username %}">{{ post.owner.get_full_name }}</a>
                                    posted:</h5>
                                    <p class="card-text">{{ post.text }}</p>
                                    <p class="card-text"><small class="text-muted">{{ post.date|timezone:"Europe/Bucharest" }}</small></p>
                                </div>
                            </div>
                            {% endif %}
                            {% if post.type == 3 %}
                                <div class="col">
                                    <img alt="da" class="card-img" id="myImg"
                                         src="{{ post.media.url }}" style="height: 200px; width: 240px">
                                </div>
                                <div class="img_modal" id="myModal">
                                    <span class="close">&times;</span>
                                    <img class="img_modal-content" id="img01" alt="da">
                                    <div id="caption"></div>
                                </div>
                                <div class="col-10">
                                <div class="card-body">
                                    <h5 class="card-title"><a href="{% url 'accounts:user_account' username=post.owner.username %}">{{ post.owner.get_full_name }}</a>
                                    posted:</h5>
                                    <p class="card-text">{{ post.text }}</p>
                                    <p class="card-text"><small class="text-muted">{{ post.date|timezone:"Europe/Bucharest" }}</small></p>
                                </div>
                            </div>
                            {% endif %}
                            <script>
                                const modal = document.getElementById("myModal");

                                const img = document.getElementById("myImg");
                                const modalImg = document.getElementById("img01");
                                const captionText = document.getElementById("caption");
                                img.onclick = function(){
                                    modal.style.display = "block";
                                    modalImg.src = this.src;
                                    captionText.innerHTML = this.alt;
                                }

                                const span = document.getElementsByClassName("close")[0];

                                span.onclick = function() {
                                    modal.style.display = "none";
                                }
                            </script>
                        {% else %}
                            <div class="col-12">
                                <div class="card-body">
                                    <h5 class="card-title"><a href="{% url 'accounts:user_account' username=post.owner.username %}">{{ post.owner.get_full_name }}</a>
                                    posted:</h5>
                                    <p class="card-text">{{ post.text }}</p>
                                    <p class="card-text"><small class="text-muted">{{ post.date|timezone:"Europe/Bucharest" }}</small></p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}